<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Route Advanced Tracking & Compliance</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for better visuals -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Configure Tailwind for custom theme and animations -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Zenith Route High-Tech Corporate Colors
                        'primary': '#1E3A8A', // Deep Navy Blue
                        'accent': '#38BDF8', // Bright Cyan/Sky Blue
                        'secondary': '#E0F2F7', // Very light blue-gray
                        'success': '#10B981',
                        'info': '#3B82F6',
                        'warning': '#F59E0B',
                        'danger': '#EF4444',
                        'status-pending': '#FBBF24',
                        'status-delivered': '#10B981',
                        'status-transit': '#3B82F6',
                        'status-exception': '#EF4444',
                        'status-cleared': '#1E3A8A',
                    }
                }
            }
        }
    </script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Custom body background: Subtle gradient on a light canvas */
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #ffffff 100%);
        }
        
        /* Timeline Styling */
        .timeline-line {
            width: 4px; /* Thicker line for visual weight */
            background-color: #E5E7EB; 
            position: absolute;
            left: 17px; 
            top: 0;
            bottom: 0;
        }

        /* Card Hover and Shadow Effect */
        .tracking-result, .input-card {
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 20px -5px rgba(30, 58, 138, 0.15);
        }
        .tracking-result:hover, .input-card:hover {
            box-shadow: 0 25px 50px -12px rgba(30, 58, 138, 0.3); /* Intense shadow on hover */
            transform: translateY(-4px);
        }

        /* Map Placeholder Style - Dark and professional */
        .map-placeholder {
            background: #252e47; /* Dark background for professional map look */
            background-image: radial-gradient(#394a6a 1px, transparent 0);
            background-size: 25px 25px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.7);
            position: relative;
            overflow: hidden;
            border: 2px solid #38BDF8;
        }

        /* Custom animation for map pin */
        @keyframes pulse-pin {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pulse-pin {
            animation: pulse-pin 2s infinite ease-in-out;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        /* Loading Animation */
        @keyframes rotating {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-fast {
            animation: rotating 0.8s linear infinite;
        }
    </style>
</head>
<body class="font-sans min-h-screen">

    <header class="bg-primary text-white shadow-2xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex justify-between items-center">
            <h1 class="text-4xl font-black tracking-wider flex items-center">
                <i data-lucide="route" class="h-8 w-8 mr-3 text-accent"></i> ZENITH ROUTE 
                <span class="text-accent text-lg font-semibold ml-3 hidden sm:inline-block">ADVANCED LOGISTICS & COMPLIANCE</span>
            </h1>
            <div class="hidden sm:block">
                <a href="#" class="text-secondary hover:text-accent px-4 py-2 rounded-lg text-lg font-medium transition duration-300">Support Center</a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <!-- Tracking Input Card -->
        <div class="input-card bg-white p-6 sm:p-12 rounded-3xl mb-16 border-t-4 border-accent">
            <h2 class="text-4xl font-black text-primary mb-3">Global Consignment Visibility</h2>
            <p class="text-gray-600 mb-8 text-xl">Enter your secure Consignment ID to access real-time status and manage critical regulatory clearance procedures.</p>

            <div class="flex flex-col sm:flex-row gap-5">
                <input
                    type="text"
                    id="trackingInput"
                    placeholder="Enter Consignment ID (e.g., ZEN123456789 or ZRC33334)"
                    class="flex-grow p-5 border-2 border-gray-300 rounded-xl focus:ring-accent focus:border-accent text-xl transition duration-200 ease-in-out shadow-lg placeholder-gray-400"
                >
                <button
                    onclick="trackShipment()"
                    class="w-full sm:w-64 px-8 py-5 bg-primary text-white font-extrabold rounded-xl shadow-2xl hover:bg-primary/90 focus:outline-none focus:ring-4 focus:ring-accent/50 transition duration-300 text-xl transform hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center"
                >
                    <i data-lucide="radar" class="h-6 w-6 mr-2"></i> Initiate Search
                </button>
            </div>
        </div>

        <!-- Results Display Area -->
        <div id="resultsContainer">
            <div id="initialMessage" class="text-center p-20 bg-white rounded-3xl shadow-xl border-2 border-dashed border-accent/50 transform scale-[0.98] opacity-90 transition duration-500">
                <i data-lucide="package-search" class="mx-auto h-24 w-24 text-accent mb-4"></i>
                <h3 class="mt-4 text-4xl font-bold text-gray-900">Awaiting Consignment Input</h3>
                <p class="mt-2 text-xl text-gray-500">Your route to seamless global trade management starts with a valid tracking ID.</p>
            </div>
        </div>
    </main>

    <!-- Customs Clearance Payment Modal -->
    <div id="clearanceModal" class="fixed inset-0 hidden z-50 overflow-y-auto modal-backdrop" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen p-4 text-center sm:p-0">
            <!-- Modal panel -->
            <div class="relative bg-white rounded-3xl text-left overflow-hidden shadow-4xl transform transition-all sm:my-8 sm:max-w-2xl sm:w-full border-t-8 border-warning">
                <div class="bg-white p-8 sm:p-10">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-16 w-16 rounded-full bg-warning/10 sm:mx-0 sm:h-14 sm:w-14">
                            <i data-lucide="alert-octagon" class="h-8 w-8 text-warning"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-6 sm:text-left w-full">
                            <h3 class="text-3xl leading-6 font-extrabold text-gray-900" id="modal-title">
                                Regulatory Compliance & Fee Settlement
                            </h3>
                            <p id="modal-tracking-number" class="text-lg text-gray-500 mt-2 font-medium"></p>
                            <p class="text-sm text-danger mt-1">Status: Consignment is on Regulatory Hold. Immediate action required for release.</p>
                            
                            <div class="mt-8">
                                <div id="modal-cost-info" class="p-5 bg-secondary rounded-xl font-black text-2xl text-primary text-center mb-6 shadow-inner"></div>
                                
                                <h4 class="text-xl font-bold text-gray-700 mb-4 border-b-2 pb-2 border-accent/50">Mandatory Release Protocols:</h4>
                                <div id="modal-actions-container" class="space-y-6">
                                    <!-- Dynamic action buttons will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-5 sm:flex sm:flex-row-reverse rounded-b-3xl">
                    <button type="button" onclick="closeClearanceModal()" class="w-full inline-flex justify-center rounded-xl border-2 border-gray-300 shadow-md px-6 py-3 bg-white text-lg font-semibold text-gray-700 hover:bg-gray-200 sm:mt-0 sm:ml-3 sm:w-auto transition duration-200">
                        Close Portal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE PLACEHOLDERS (Required for environment, even if not used) ---
        const __app_id = 'zenith-route-v5';
        const __firebase_config = '{}';
        const __initial_auth_token = 'mock-auth-token';

        // --- USER-PROVIDED TEST KEY ---
        const TEST_PAYMENT_KEY = 'pk_test_cdbf17939cecdf30d94efbaad720a7e4fe2564ed';


        // --- MOCK DATABASE (Updated with professional data and volumetric weight) ---
        let MOCK_SHIPMENTS = [
            // In Transit - Clear
            {
                trackingNumber: 'ZEN123456789',
                status: 'In Transit',
                statusKey: 'status-transit',
                senderName: 'TechGlobal Inc. (SHZ)',
                receiverName: 'Alice Johnson (NYC)',
                origin: 'Shenzhen, China',
                destination: 'New York, USA',
                estimatedDelivery: '2025-11-05',
                service: 'Premium Air Express',
                weight: '2.5 kg',
                volumetricWeight: '4.8 kg',
                currentGeo: { lat: 35.15, lng: -90.0, location: 'Memphis, TN' }, 
                isClearanceNeeded: false,
                customsInfo: { cost: 0, documentsRequired: false, isPaid: true, isDocumentsSubmitted: true },
                receivedBy: null,
                history: [
                    { date: '10/29', time: '09:30 AM', location: 'Memphis, TN', description: 'Arrived at Regional Sortation Hub. Processing in progress.' },
                    { date: '10/28', time: '11:00 PM', location: 'Anchorage, AK', description: 'Departed Transit Air Freight Terminal.' },
                ]
            },
            // Delivered - Awaiting Recipient Confirmation
            {
                trackingNumber: 'ZRC987654321',
                status: 'Delivered',
                statusKey: 'status-delivered',
                senderName: 'Bookworm Publishers (LDN)',
                receiverName: 'Robert Smith (CHI)',
                origin: 'London, UK',
                destination: 'Chicago, USA',
                estimatedDelivery: '2025-10-20',
                service: 'Standard Ground Freight',
                weight: '15.0 kg',
                volumetricWeight: '12.0 kg',
                currentGeo: { lat: 41.87, lng: -87.62, location: 'Chicago, IL' },
                isClearanceNeeded: false,
                customsInfo: { cost: 0, documentsRequired: false, isPaid: true, isDocumentsSubmitted: true },
                receivedBy: null, 
                history: [
                    { date: '10/20', time: '02:15 PM', location: 'Chicago, IL', description: 'Delivery confirmed and finalized by courier.' },
                    { date: '10/20', time: '08:00 AM', location: 'Chicago, IL', description: 'Outbound for final mile delivery attempt.' },
                ]
            },
            // Awaiting Clearance - NEEDS PAYMENT & DOCUMENTS
            {
                trackingNumber: 'ZRC33334',
                status: 'Awaiting Clearance',
                statusKey: 'status-pending',
                senderName: 'Nippon Electronics (TYO)',
                receiverName: 'Zenith HQ (LAX)',
                origin: 'Tokyo, Japan',
                destination: 'Los Angeles, USA',
                estimatedDelivery: '2025-11-03',
                service: 'Ocean Cargo Express',
                weight: '150.0 kg',
                volumetricWeight: '210.5 kg',
                currentGeo: { lat: 33.7, lng: -118.2, location: 'Port of Los Angeles, CA' },
                isClearanceNeeded: true, 
                customsInfo: { cost: 250.75, documentsRequired: true, isPaid: false, isDocumentsSubmitted: false },
                receivedBy: null,
                history: [
                    { date: '10/29', time: '07:00 AM', location: 'LA Port Authority', description: 'Consignment docked. Regulatory payment and documentation submission required for immediate release.' },
                    { date: '10/20', time: '11:00 PM', location: 'Tokyo Port', description: 'Shipment loaded onto vessel, departed origin port.' },
                ]
            }
        ];

        const resultsContainer = document.getElementById('resultsContainer');
        const clearanceModal = document.getElementById('clearanceModal');

        /**
         * Converts the status key into Tailwind classes for styling.
         */
        function getStatusClasses(statusKey) {
            switch (statusKey) {
                case 'status-delivered':
                    return 'bg-success text-white';
                case 'status-transit':
                    return 'bg-info text-white';
                case 'status-exception':
                    return 'bg-danger text-white';
                case 'status-pending':
                    return 'bg-warning text-gray-800';
                default: 
                    return 'bg-status-cleared text-white';
            }
        }

        /**
         * Utility to display a temporary notification message.
         */
        function displayTemporaryMessage(title, message, color = 'success') {
            const successBox = document.createElement('div');
            successBox.className = `fixed top-6 right-6 p-5 rounded-xl shadow-2xl text-white bg-${color} z-50 transform transition duration-500 ease-out translate-x-0 opacity-100`;
            successBox.innerHTML = `<p class="font-bold text-lg">${title}</p><p class="text-sm">${message}</p>`;
            document.body.appendChild(successBox);

            setTimeout(() => {
                successBox.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => successBox.remove(), 500);
            }, 5000);
        }

        /**
         * Recipient action: Marks a delivered shipment as received.
         */
        function confirmReceipt(trackingNumber) {
            const shipmentIndex = MOCK_SHIPMENTS.findIndex(s => s.trackingNumber === trackingNumber);
            if (shipmentIndex > -1) {
                MOCK_SHIPMENTS[shipmentIndex].receivedBy = "Recipient Confirmed";
                const shipment = MOCK_SHIPMENTS[shipmentIndex];
                resultsContainer.innerHTML = renderShipmentResult(shipment);
                lucide.createIcons();
                displayTemporaryMessage("Confirmation Registered", `Consignment ${trackingNumber} receipt confirmed by receiver. Record finalized.`);
            }
        }
        
        // --- CUSTOMS CLEARANCE FUNCTIONS ---

        /**
         * Opens the detailed Customs Clearance Modal.
         */
        function openClearanceModal(trackingNumber) {
            const shipment = MOCK_SHIPMENTS.find(s => s.trackingNumber === trackingNumber);
            if (!shipment || !shipment.isClearanceNeeded) return;

            document.getElementById('modal-tracking-number').textContent = `Consignment ID: ${trackingNumber}`;
            
            const costText = shipment.customsInfo.isPaid 
                ? 'COMPLIANCE STATUS: DUTIES AND TAXES SETTLED'
                : `TOTAL REGULATORY FEES DUE: $${shipment.customsInfo.cost.toFixed(2)}`;
            document.getElementById('modal-cost-info').innerHTML = costText;

            renderClearanceActions(shipment);
            clearanceModal.classList.remove('hidden');
        }

        /**
         * Closes the Customs Clearance Modal.
         */
        function closeClearanceModal() {
            clearanceModal.classList.add('hidden');
        }

        /**
         * Renders the action buttons inside the clearance modal based on current status.
         */
        function renderClearanceActions(shipment) {
            const actionsContainer = document.getElementById('modal-actions-container');
            let html = '';

            // 1. Document Submission Step
            if (shipment.customsInfo.documentsRequired && !shipment.customsInfo.isDocumentsSubmitted) {
                html += `
                    <div class="flex items-center p-4 border rounded-xl shadow-sm bg-accent/10">
                        <i data-lucide="upload-cloud" class="h-6 w-6 text-primary mr-4 flex-shrink-0"></i>
                        <div class="flex-grow">
                            <p class="font-medium text-gray-700">Submit Required Trade Documentation</p>
                            <p class="text-xs text-gray-500">Commercial Invoice, KYC/ID Verification</p>
                        </div>
                        <button onclick="simulateClearanceAction('${shipment.trackingNumber}', 'documents')" class="ml-4 px-4 py-2 bg-primary text-white text-sm font-semibold rounded-lg hover:bg-primary/80 transition">
                            Submit Documents
                        </button>
                    </div>
                `;
            } else if (shipment.customsInfo.documentsRequired) {
                 html += `
                    <div class="flex items-center p-4 border border-success/50 bg-green-50 rounded-xl shadow-inner">
                        <i data-lucide="check-circle" class="h-6 w-6 text-success mr-4 flex-shrink-0"></i>
                        <p class="flex-grow font-medium text-success">Documentation Verified and Approved</p>
                    </div>
                `;
            }

            // 2. Payment Step - Now with a loading state simulation
            if (!shipment.customsInfo.isPaid) {
                html += `
                    <div class="flex items-center p-4 border rounded-xl shadow-sm bg-warning/10">
                        <i data-lucide="credit-card" class="h-6 w-6 text-warning mr-4 flex-shrink-0"></i>
                        <div class="flex-grow">
                            <p class="font-medium text-gray-700">Settle Regulatory Duties and Taxes</p>
                            <p class="text-xs text-gray-500">Payment Gateway: Zenith Secure (Key: ${TEST_PAYMENT_KEY.substring(0, 10)}...)</p>
                        </div>
                        <button id="payButton_${shipment.trackingNumber}" onclick="simulateClearanceAction('${shipment.trackingNumber}', 'payment')" class="ml-4 px-4 py-2 bg-warning text-white text-sm font-semibold rounded-lg shadow-lg hover:bg-warning/90 transition">
                            Pay $${shipment.customsInfo.cost.toFixed(2)}
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div class="flex items-center p-4 border border-success/50 bg-green-50 rounded-xl shadow-inner">
                        <i data-lucide="check-circle" class="h-6 w-6 text-success mr-4 flex-shrink-0"></i>
                        <p class="flex-grow font-medium text-success">Financial Obligations Fulfilled</p>
                    </div>
                `;
            }

            actionsContainer.innerHTML = html;
            lucide.createIcons();
        }

        /**
         * Simulates a single action (payment or document submission) and checks for final clearance.
         */
        function simulateClearanceAction(trackingNumber, actionType) {
            const shipmentIndex = MOCK_SHIPMENTS.findIndex(s => s.trackingNumber === trackingNumber);
            if (shipmentIndex === -1) return;

            let shipment = MOCK_SHIPMENTS[shipmentIndex];
            const payButton = document.getElementById(`payButton_${trackingNumber}`);

            if (actionType === 'payment') {
                if(payButton) {
                    payButton.innerHTML = `<i data-lucide="loader-circle" class="h-5 w-5 animate-spin-fast"></i> Processing...`;
                    payButton.disabled = true;
                    
                    // Simulate payment processing delay
                    setTimeout(() => {
                        shipment.customsInfo.isPaid = true;
                        displayTemporaryMessage("Payment Successful", `Transaction approved via Zenith Secure Gateway. Key: ${TEST_PAYMENT_KEY.substring(0, 10)}...`, 'info');
                        
                        // Check for final clearance after simulated payment
                        checkAndFinalizeClearance(shipment, trackingNumber);

                    }, 2500); // 2.5 second delay for realism
                }

            } else if (actionType === 'documents') {
                shipment.customsInfo.isDocumentsSubmitted = true;
                displayTemporaryMessage("Documentation Submitted", `Trade documents received and queued for customs validation.`, 'info');
                
                // Check for final clearance immediately after document submission (assuming instant validation for mock)
                checkAndFinalizeClearance(shipment, trackingNumber);
            }
        }

        /**
         * Checks if all clearance conditions are met and finalizes the shipment status.
         */
        function checkAndFinalizeClearance(shipment, trackingNumber) {
            // Re-render modal to update statuses
            renderClearanceActions(shipment);
            
            if (shipment.customsInfo.isPaid && (!shipment.customsInfo.documentsRequired || shipment.customsInfo.isDocumentsSubmitted)) {
                
                // Update final clearance status
                shipment.isClearanceNeeded = false;
                shipment.status = "Cleared, En Route to Destination";
                shipment.statusKey = "status-cleared";
                
                // Add a new event to the history
                const date = new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
                const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                shipment.history.unshift({
                    date: date,
                    time: time,
                    location: shipment.currentGeo.location,
                    description: 'Customs Clearance Complete! Shipment released and routed for final delivery scheduling.'
                });

                // Close modal and re-render the main tracking page
                setTimeout(() => {
                    closeClearanceModal();
                    resultsContainer.innerHTML = renderShipmentResult(shipment);
                    lucide.createIcons();
                    displayTemporaryMessage("Regulatory Release Granted", `Consignment ${trackingNumber} has been officially cleared and is moving to delivery.`, 'success');
                }, 100);
            }
        }
        
        /**
         * Renders a simulated map display for the current location.
         */
        function renderMap(geo) {
            const latPercent = ((geo.lat + 90) / 180) * 100; // Normalized latitude (0-100)
            const lngPercent = ((geo.lng + 180) / 360) * 100; // Normalized longitude (0-100)

            return `
                <div class="w-full h-80 map-placeholder rounded-2xl shadow-xl relative mb-6">
                    <!-- Stylized Globe/Route lines -->
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="w-2/3 h-2/3 border-4 border-dashed border-accent/40 rounded-full animate-spin-slow"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-accent text-3xl font-black italic opacity-10">ZENITH ROUTE</div>
                    </div>

                    <!-- Current Location Marker -->
                    <div class="absolute p-3 bg-accent rounded-full shadow-2xl border-4 border-white animate-pulse-pin" 
                         style="top: calc(${100 - latPercent}% - 16px); left: calc(${lngPercent}% - 16px);"
                         title="Current Location: ${geo.location}">
                        <i data-lucide="locate-fixed" class="h-6 w-6 text-primary"></i>
                    </div>

                    <div class="absolute bottom-4 left-4 bg-white/95 backdrop-blur-sm p-3 rounded-lg text-lg font-bold text-gray-800 shadow-xl border border-accent/50">
                        <i data-lucide="map-pin" class="h-5 w-5 inline mr-2 text-primary"></i> Current Location: ${geo.location}
                    </div>
                </div>
            `;
        }

        /**
         * Renders the HTML template for a single tracking result.
         */
        function renderShipmentResult(shipment) {
            const statusClasses = getStatusClasses(shipment.statusKey);
            const currentGeo = shipment.currentGeo;

            // --- Clearance/Goods Management Block ---
            let clearanceActionBlock = '';
            if (shipment.isClearanceNeeded) {
                clearanceActionBlock = `
                    <div class="p-8 bg-warning/10 border-l-8 border-warning rounded-2xl shadow-2xl mb-12 transition duration-300">
                        <div class="flex items-center mb-4">
                            <i data-lucide="gavel" class="h-7 w-7 text-warning mr-4"></i>
                            <h4 class="text-2xl font-bold text-gray-800">Regulatory Hold Initiated</h4>
                        </div>
                        <p class="text-gray-600 mb-6 text-base">This consignment requires immediate **Regulatory Compliance & Fee Settlement** for release from Customs. Proceed to the portal to submit documentation and duty payments.</p>
                        <button onclick="openClearanceModal('${shipment.trackingNumber}')" class="w-full sm:w-80 px-8 py-4 bg-warning text-white font-semibold rounded-xl shadow-lg hover:bg-warning/90 focus:ring-4 focus:ring-warning/50 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center">
                            <i data-lucide="file-check-2" class="h-5 w-5 inline mr-3"></i> Access Compliance Portal
                        </button>
                    </div>
                `;
            }

            // --- Recipient Status/Confirmation Block ---
            let recipientActionBlock = '';
            if (shipment.statusKey === 'status-delivered' && !shipment.receivedBy) {
                recipientActionBlock = `
                    <div class="p-8 bg-success/10 border-l-8 border-success rounded-2xl shadow-2xl mb-12 transition duration-300">
                        <div class="flex items-center mb-4">
                            <i data-lucide="package-check" class="h-7 w-7 text-success mr-4"></i>
                            <h4 class="text-2xl font-bold text-gray-800">Final Delivery Confirmation</h4>
                        </div>
                        <p class="text-gray-600 mb-6 text-base">The physical delivery has been recorded. Please confirm receipt to finalize the transit record and authorize final closure of the Consignment ID.</p>
                        <button onclick="confirmReceipt('${shipment.trackingNumber}')" class="w-full sm:w-80 px-8 py-4 bg-success text-white font-semibold rounded-xl shadow-lg hover:bg-success/90 focus:ring-4 focus:ring-success/50 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center">
                            <i data-lucide="handshake" class="h-5 w-5 inline mr-3"></i> Confirm Physical Receipt
                        </button>
                    </div>
                `;
            } else if (shipment.receivedBy) {
                 recipientActionBlock = `
                    <div class="p-5 bg-green-100 border border-success/50 rounded-xl shadow-inner mb-12 text-center">
                         <p class="text-xl font-extrabold text-success flex items-center justify-center">
                            <i data-lucide="bookmark-check" class="h-6 w-6 mr-3"></i> TRANSIT RECORD CLOSED: DELIVERED & CONFIRMED
                         </p>
                         <p class="text-sm text-gray-700 mt-1">Finalized by Consignee: ${shipment.receiverName}</p>
                    </div>
                `;
            }

            // Generate the timeline history HTML
            const historyHtml = shipment.history.map((event, index) => {
                const isLatest = index === 0;
                const dotColor = isLatest ? 'bg-accent ring-4 ring-primary/30' : 'bg-gray-400';
                const textColor = isLatest ? 'font-bold text-gray-900' : 'text-gray-600';

                return `
                    <li class="relative pb-8 pl-10">
                        <!-- Timeline Pin/Dot -->
                        <div class="absolute top-0 left-0 w-8 h-8 flex items-center justify-center">
                            <span class="w-5 h-5 rounded-full ${dotColor} z-10 ${isLatest ? 'animate-pulse' : ''}"></span>
                        </div>
                        <div class="ml-4 p-5 rounded-xl bg-white hover:bg-gray-50 transition duration-150 ease-in-out shadow-lg border-l-4 border-primary/20">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-2 border-b border-dashed pb-2">
                                <p class="text-xs font-bold text-primary uppercase tracking-widest flex items-center">
                                    <i data-lucide="clock" class="h-3 w-3 mr-1"></i> ${event.date} / ${event.time}
                                </p>
                                <p class="text-sm text-gray-500 font-medium mt-1 sm:mt-0 flex items-center">
                                    <i data-lucide="send" class="h-4 w-4 mr-1"></i> ${event.location}
                                </p>
                            </div>
                            <p class="${textColor} text-base">${event.description}</p>
                        </div>
                    </li>
                `;
            }).join('');

            // Assemble the main result card
            const resultHtml = `
                <div class="tracking-result bg-white p-6 sm:p-12 rounded-3xl border-t-4 border-primary">
                    
                    <!-- Header and Status -->
                    <div class="flex justify-between items-start flex-wrap gap-4 mb-10 border-b-2 pb-6 border-gray-200">
                        <h3 class="text-4xl font-extrabold text-gray-900 flex items-center">
                            <i data-lucide="clipboard-list" class="h-8 w-8 mr-3 text-primary"></i> Consignment ID: <span class="text-accent ml-2 tracking-tight">${shipment.trackingNumber}</span>
                        </h3>
                        <span class="px-6 py-2 rounded-full text-lg font-extrabold tracking-wider ${statusClasses} shadow-xl">
                            ${shipment.status.toUpperCase()}
                        </span>
                    </div>

                    <!-- Dynamic Action Blocks -->
                    ${clearanceActionBlock}
                    ${recipientActionBlock}

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Map View (2/3 width on large screens) -->
                        <div class="lg:col-span-2">
                            <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="map" class="h-6 w-6 mr-2 text-primary"></i> Real-Time Geospatial Tracking
                            </h4>
                            ${renderMap(currentGeo)}
                            <div class="p-4 bg-secondary rounded-xl shadow-inner text-sm text-gray-700 mt-4 border border-accent/30">
                                <p class="font-bold">Protocol Advisory:</p>
                                <p>Map location updates automatically every 5 minutes from the last reported waypoint. Data provided in UTC/Zulu time.</p>
                            </div>
                        </div>
                        
                        <!-- Sender/Receiver and Core Metrics (1/3 width on large screens) -->
                        <div class="lg:col-span-1 space-y-6">
                            <h4 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="list-ordered" class="h-6 w-6 mr-2 text-primary"></i> Consignment Dossier
                            </h4>
                            
                            <!-- Sender/Receiver Block -->
                            <div class="p-5 bg-primary/90 rounded-2xl shadow-xl text-white">
                                <p class="text-xs font-semibold uppercase text-accent mb-2">Transaction Parties</p>
                                <p class="text-lg font-bold flex items-center"><i data-lucide="arrow-up-right" class="h-4 w-4 mr-2 text-accent"></i> Shipper: ${shipment.senderName}</p>
                                <p class="text-lg font-bold flex items-center mt-1"><i data-lucide="arrow-down-left" class="h-4 w-4 mr-2 text-accent"></i> Consignee: ${shipment.receiverName}</p>
                            </div>

                            <!-- Core Metrics List -->
                            <div class="p-5 bg-white rounded-2xl shadow-xl border border-gray-200 space-y-3">
                                <div class="flex justify-between items-center pb-2 border-b border-dashed">
                                    <p class="text-sm font-medium text-gray-600 flex items-center"><i data-lucide="calendar" class="h-5 w-5 mr-2 text-primary"></i> Est. Delivery Date</p>
                                    <p class="text-lg font-extrabold text-primary">${shipment.estimatedDelivery}</p>
                                </div>
                                <div class="flex justify-between items-center pb-2 border-b border-dashed">
                                    <p class="text-sm font-medium text-gray-600 flex items-center"><i data-lucide="box" class="h-5 w-5 mr-2 text-primary"></i> Dead Weight</p>
                                    <p class="text-lg font-extrabold text-primary">${shipment.weight}</p>
                                </div>
                                <div class="flex justify-between items-center">
                                    <p class="text-sm font-medium text-gray-600 flex items-center"><i data-lucide="scale" class="h-5 w-5 mr-2 text-primary"></i> Volumetric Weight</p>
                                    <p class="text-lg font-extrabold text-primary">${shipment.volumetricWeight}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tracking Timeline -->
                    <h4 class="text-2xl font-bold text-gray-800 mt-10 mb-6 border-t-2 pt-6 flex items-center">
                        <i data-lucide="git-branch" class="h-6 w-6 mr-3 text-primary"></i> Full Transit History Log
                    </h4>
                    <div class="relative pl-4">
                        <!-- Vertical Timeline Line -->
                        <div class="timeline-line"></div>
                        <ul class="space-y-4">
                            ${historyHtml}
                        </ul>
                    </div>
                </div>
            `;
            return resultHtml;
        }

        /**
         * Displays a generic message (initial state or error).
         */
        function displayMessage(title, message, iconName = 'search') {
            resultsContainer.innerHTML = `
                <div class="text-center p-20 bg-white rounded-3xl shadow-xl border-2 border-dashed border-accent/50 transform scale-[0.98] opacity-90 transition duration-500">
                    <i data-lucide="${iconName}" class="mx-auto h-24 w-24 text-accent mb-4 animate-pulse-slow"></i>
                    <h3 class="mt-4 text-4xl font-bold text-gray-900">${title}</h3>
                    <p class="mt-2 text-xl text-gray-500">${message}</p>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * Main function to handle the tracking submission.
         */
        function trackShipment() {
            const trackingInput = document.getElementById('trackingInput');
            const trackingNumber = trackingInput.value.trim().toUpperCase();

            resultsContainer.innerHTML = ''; // Clear previous results

            if (!trackingNumber) {
                displayMessage(
                    "Input Error",
                    "Please provide a valid Consignment ID to commence tracking.",
                    'alert-triangle'
                );
                return;
            }

            // Simulate API call delay with professional loading message
            displayMessage(
                "Establishing Connection...", 
                "Retrieving live data from the global logistics matrix. Please wait for real-time dossier upload.", 
                'loader-circle'
            );

            setTimeout(() => {
                const shipment = MOCK_SHIPMENTS.find(s => s.trackingNumber === trackingNumber);

                if (shipment) {
                    resultsContainer.innerHTML = renderShipmentResult(shipment);
                    lucide.createIcons(); 
                } else {
                    displayMessage(
                        "Consignment ID Not Found",
                        `The identifier "${trackingNumber}" does not correspond to any active consignment record in our system.`,
                        'alert-circle'
                    );
                }
            }, 2000); // 2 second delay for a "professional" load
        }

        // Add event listener for 'Enter' key press on the input field and initial icon rendering
        document.addEventListener('DOMContentLoaded', () => {
            const trackingInput = document.getElementById('trackingInput');
            trackingInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    trackShipment();
                }
            });
            lucide.createIcons();
        });

        // Add CSS keyframes to the document head
        const style = document.createElement('style');
        style.textContent += `
            @keyframes pulse-slow {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.6; }
            }
            .animate-pulse-slow {
                animation: pulse-slow 5s infinite;
            }
            @keyframes spin-slow {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            .animate-spin-slow {
                animation: spin-slow 20s linear infinite;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
